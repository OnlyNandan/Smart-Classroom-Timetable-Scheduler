{% extends "base.html" %}

{% block title %}Timetable Management{% endblock %}

{% block header %}
<h1 class="text-3xl font-bold text-gray-200">Timetable Management</h1>
<p class="text-gray-400 mt-1">Manage and generate timetables for all classes, grades, and streams</p>
{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Controls Panel -->
    <div class="glass-card p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-200">Section Timetables</h2>
            </div>

                <div class="flex items-center gap-3">
                    <button id="generate-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Generate Timetable
                    </button>
                    
                    <button id="export-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </div>

    <!-- Timetable Display -->
    <div class="glass-card p-6">
        <div class="mb-4 flex items-center justify-between">
            <h2 class="text-2xl font-semibold text-gray-200">Timetable</h2>
            <div class="flex items-center gap-2 text-sm text-gray-400">
                <span id="last-generated">Last generated: Never</span>
                <span id="generation-status" class="px-2 py-1 rounded-full text-xs"></span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-400">Loading timetable...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-100">No timetable data</h3>
            <p class="mt-1 text-sm text-gray-400">Generate a timetable to get started.</p>
            <div class="mt-6">
                <button id="generate-empty-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Generate Timetable
                </button>
            </div>
        </div>

        <!-- Selection Controls -->
        <div class="glass-card p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-200 mb-4">Select Timetable View</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Semester</label>
                    <select id="semester-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Semesters</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Department</label>
                    <select id="department-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Section</label>
                    <select id="section-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">All Sections</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="clear-filter-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Clear Filter
                </button>
            </div>
        </div>

        <!-- Section Timetables Container -->
        <div id="timetables-container" class="space-y-8">
            <!-- Section timetables will be populated by JavaScript -->
        </div>
    </div>

    <!-- Statistics Panel -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-900 text-blue-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Total Classes</p>
                    <p id="total-classes" class="text-2xl font-semibold text-gray-100">0</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-900 text-green-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Scheduled</p>
                    <p id="scheduled-classes" class="text-2xl font-semibold text-gray-100">0</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-900 text-yellow-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Conflicts</p>
                    <p id="conflicts" class="text-2xl font-semibold text-gray-100">0</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-900 text-purple-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Efficiency</p>
                    <p id="efficiency" class="text-2xl font-semibold text-gray-100">0%</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generation Modal -->
<div id="generation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg max-w-md w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-900 mb-4">
                    <svg class="h-6 w-6 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-100 mb-2">Generating Timetables</h3>
                <p class="text-sm text-gray-400 mb-2">Processing sections one by one...</p>
                <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progress-details" class="text-xs text-gray-400 space-y-1">
                    <div id="current-section" class="text-blue-400">Preparing...</div>
                    <div id="sections-completed" class="text-gray-500">0 sections completed</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 right-5 z-50 hidden">
    <div class="bg-gray-800 rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="flex-shrink-0"></div>
            <div class="ml-3">
                <p id="toast-message" class="text-sm font-medium text-gray-100"></p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const APP_MODE = '{{ g.app_mode }}';
    const SETTINGS = {{ settings | tojson }};
    
    // Element references
    const generateBtn = document.getElementById('generate-btn');
    const exportBtn = document.getElementById('export-btn');
    const generateEmptyBtn = document.getElementById('generate-empty-btn');
    const timetablesContainer = document.getElementById('timetables-container');
    const emptyState = document.getElementById('empty-state');
    const loadingState = document.getElementById('loading-state');
    
    // Filter controls
    const semesterSelect = document.getElementById('semester-select');
    const departmentSelect = document.getElementById('department-select');
    const sectionSelect = document.getElementById('section-select');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const generationModal = document.getElementById('generation-modal');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const toast = document.getElementById('toast');
    
    // State
    let timetableData = [];
    
    // Initialize
    loadTimetableData();
    setupEventListeners();
    
    function setupEventListeners() {
        generateBtn.addEventListener('click', generateTimetable);
        generateEmptyBtn.addEventListener('click', generateTimetable);
        exportBtn.addEventListener('click', exportTimetable);
        
        // Filter controls - auto-apply on change
        semesterSelect.addEventListener('change', () => {
            updateDepartmentOptions();
            applyFilter();
        });
        departmentSelect.addEventListener('change', () => {
            updateSectionOptions();
            applyFilter();
        });
        sectionSelect.addEventListener('change', applyFilter);
        clearFilterBtn.addEventListener('click', clearFilter);
    }
    
    async function loadTimetableData() {
        console.log('🔄 Loading timetable data...');
        showLoading();
        try {
            const response = await fetch('/api/timetable_data');
            console.log('📡 API response status:', response.status);
            
            if (response.ok) {
                timetableData = await response.json();
                console.log('📊 Received timetable data:', timetableData.length, 'entries');
                console.log('📄 Sample data:', timetableData[0]);
                
                updateStatistics();
                renderTimetable();
                hideLoading();
                
                if (timetableData.length === 0) {
                    console.log('📭 No data, showing empty state');
                    showEmptyState();
                } else {
                    console.log('✅ Data loaded, showing timetable');
                    showTimetable();
                }
            } else {
                const errorData = await response.json();
                console.error('❌ API error:', errorData);
                throw new Error('Failed to load timetable data');
            }
        } catch (error) {
            console.error('Error loading timetable:', error);
            showToast('Failed to load timetable data', 'error');
            hideLoading();
            showEmptyState();
        }
    }
    
    
    
    function renderTimetable() {
        if (timetableData.length === 0) {
            showEmptyState();
            return;
        }
        
        console.log('🎨 Rendering section timetables...');
        console.log('📊 Data to render:', timetableData.length, 'entries');
        
        hideLoading();
        showTimetable();
        
        // Get unique sections - group by section name AND department to handle duplicate names
        const sectionGroups = {};
        timetableData.forEach(entry => {
            const key = `${entry.section_name}_${entry.department_name}`;
            if (!sectionGroups[key]) {
                sectionGroups[key] = {
                    section: entry.section_name,
                    department: entry.department_name,
                    semester: entry.semester_name,
                    entries: []
                };
            }
            sectionGroups[key].entries.push(entry);
        });
        
        const sections = Object.values(sectionGroups).sort((a, b) => {
            if (a.semester !== b.semester) return a.semester.localeCompare(b.semester);
            if (a.department !== b.department) return a.department.localeCompare(b.department);
            return a.section.localeCompare(b.section);
        });
        const days = SETTINGS.working_days || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const periods = generatePeriods();
        
        console.log('📚 Sections:', sections);
        console.log('📚 Total sections found:', sections.length);
        console.log('📅 Days:', days);
        console.log('⏰ Periods:', periods);
        console.log('📊 Total timetable data entries:', timetableData.length);
        console.log('🔍 First 10 entries:', timetableData.slice(0, 10));
        
        // Debug: Show section distribution
        sections.forEach(section => {
            const sectionData = timetableData.filter(entry => entry.section_name === section.section);
            console.log(`📋 Section ${section.section}: ${sectionData.length} classes`);
        });
        
        // Populate filter dropdowns
        populateFilterDropdowns();
        
        // Clear container
        timetablesContainer.innerHTML = '';
        
        // Create a table for each section
        console.log(`🎨 Creating tables for ${sections.length} sections`);
        console.log(`🎨 Sections array:`, sections);
        
        sections.forEach((sectionGroup, index) => {
            const sectionData = sectionGroup.entries;
            const sectionName = sectionGroup.section;
            const departmentName = sectionGroup.department;
            const semesterName = sectionGroup.semester;
            
            console.log(`📋 Section ${index + 1}/${sections.length}: ${semesterName} - ${departmentName} - ${sectionName} has ${sectionData.length} classes`);
            
            // Debug: Check if we're only processing first 5
            if (index < 10) {
                console.log(`🔍 Processing section ${index + 1}: ${semesterName} - ${departmentName} - ${sectionName}`);
            }
            
            // Create section card
            const sectionCard = document.createElement('div');
            sectionCard.className = 'glass-card p-6';
            
            // Section header with semester-department-section format
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'mb-4 flex items-center justify-between';
            
            sectionHeader.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-200">${semesterName} - ${departmentName} - ${sectionName}</h3>
                <span class="text-sm text-gray-400">${sectionData.length} classes scheduled</span>
            `;
            sectionCard.appendChild(sectionHeader);
            
            // Create table
            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto';
            
            const table = document.createElement('table');
            table.className = 'w-full border-collapse border border-gray-600';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-200 font-medium">Time</th>';
            days.forEach(day => {
                headerRow.innerHTML += `<th class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-200 font-medium">${day}</th>`;
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            periods.forEach(period => {
                const row = document.createElement('tr');
                
                // Style break periods differently
                if (period.isBreak) {
                    row.innerHTML = `<td class="border border-gray-600 px-4 py-2 bg-orange-800 text-orange-200 font-medium">${period.time}</td>`;
                    
                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'border border-gray-600 px-2 py-1 min-h-[40px] bg-orange-900';
                        
                        const breakDiv = document.createElement('div');
                        breakDiv.className = 'text-orange-300 text-center py-2 font-medium text-sm';
                        breakDiv.textContent = 'BREAK';
                        cell.appendChild(breakDiv);
                        
                        row.appendChild(cell);
                    });
                } else {
                    row.innerHTML = `<td class="border border-gray-600 px-4 py-2 bg-gray-800 text-gray-200 font-medium">${period.time}</td>`;
                    
                    days.forEach(day => {
                        const cellData = sectionData.filter(entry => 
                            entry.day === day && entry.period === period.number
                        );
                        
                        const cell = document.createElement('td');
                        cell.className = 'border border-gray-600 px-2 py-1 min-h-[60px] bg-gray-900';
                        
                        if (cellData.length > 0) {
                            cellData.forEach(entry => {
                                const classDiv = document.createElement('div');
                                classDiv.className = 'bg-blue-900 border border-blue-600 rounded p-2 mb-1 text-xs text-gray-200';
                                classDiv.innerHTML = `
                                    <div class="font-medium text-blue-300">${entry.subject_name || entry.course_name || 'Unknown'}</div>
                                    <div class="text-gray-300">${entry.teacher_name || 'Unknown'}</div>
                                    <div class="text-gray-400">${entry.classroom_name || 'Unknown'}</div>
                                `;
                                cell.appendChild(classDiv);
                            });
                        } else {
                            cell.innerHTML = '<div class="text-gray-500 text-center py-4">-</div>';
                        }
                        
                        row.appendChild(cell);
                    });
                }
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            sectionCard.appendChild(tableContainer);
            timetablesContainer.appendChild(sectionCard);
        });
    }
    
    function generatePeriods() {
        // Fixed schedule with lunch break - 60 minute classes
        const periods = [
            { number: 1, time: "09:00 - 10:00", isBreak: false },
            { number: 2, time: "10:00 - 11:00", isBreak: false },
            { number: 3, time: "11:00 - 12:00", isBreak: false },
            { number: 4, time: "12:00 - 13:00", isBreak: false },
            { number: 5, time: "13:00 - 14:00", isBreak: true, label: "Lunch Break" },
            { number: 6, time: "14:00 - 15:00", isBreak: false },
            { number: 7, time: "15:00 - 16:00", isBreak: false },
            { number: 8, time: "16:00 - 17:00", isBreak: false },
            { number: 9, time: "17:00 - 18:00", isBreak: false },
            { number: 10, time: "18:00 - 19:00", isBreak: false },
            { number: 11, time: "19:00 - 20:00", isBreak: false },
            { number: 12, time: "20:00 - 21:00", isBreak: false }
        ];
        
        console.log('Generated periods:', periods);
        console.log('Break periods:', periods.filter(p => p.isBreak));
        return periods;
    }
    
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
    }
    
    function formatTime(date) {
        return date.toTimeString().slice(0, 5);
    }
    
    async function generateTimetable() {
        showGenerationModal();
        
        try {
            // Simulate section-by-section progress
            simulateSectionProgress();
            
            const response = await fetch('/api/generate_timetable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                hideGenerationModal();
                showToast(`Timetable generated! Processed ${result.sections_processed || 'all'} sections with ${result.entries_count || 'many'} entries.`, 'success');
                loadTimetableData();
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Generation failed');
            }
        } catch (error) {
            hideGenerationModal();
            showToast('Failed to generate timetable: ' + error.message, 'error');
        }
    }
    
    function simulateSectionProgress() {
        const totalSections = 50; // Approximate number of sections
        let completedSections = 0;
        let currentSectionIndex = 0;
        
        const interval = setInterval(() => {
            if (completedSections < totalSections) {
                // Update current section
                const sectionName = `Section ${String.fromCharCode(65 + (currentSectionIndex % 5))}`;
                document.getElementById('current-section').textContent = `Processing ${sectionName}...`;
                
                // Simulate section completion
                if (Math.random() > 0.7) { // 30% chance to complete a section each interval
                    completedSections++;
                    document.getElementById('sections-completed').textContent = `${completedSections} sections completed`;
                    currentSectionIndex++;
                }
                
                // Update progress bar
                const progress = (completedSections / totalSections) * 95; // Leave 5% for final completion
                document.getElementById('progress-bar').style.width = progress + '%';
                
            } else {
                // Final completion
                document.getElementById('current-section').textContent = 'Finalizing...';
                document.getElementById('progress-bar').style.width = '100%';
                clearInterval(interval);
            }
        }, 800);
    }
    
    function simulateProgress() {
        const steps = [
            { progress: 20, text: 'Analyzing constraints...' },
            { progress: 40, text: 'Optimizing schedule...' },
            { progress: 60, text: 'Assigning teachers...' },
            { progress: 80, text: 'Allocating classrooms...' },
            { progress: 100, text: 'Finalizing timetable...' }
        ];
        
        let currentStep = 0;
        const interval = setInterval(() => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                progressBar.style.width = step.progress + '%';
                progressText.textContent = step.text;
                currentStep++;
            } else {
                clearInterval(interval);
            }
        }, 1000);
    }
    
    function exportTimetable() {
        // Implement export functionality
        showToast('Export functionality coming soon!', 'info');
    }
    
    function updateStatistics() {
        document.getElementById('total-classes').textContent = timetableData.length;
        document.getElementById('scheduled-classes').textContent = timetableData.length;
        document.getElementById('conflicts').textContent = '0'; // Calculate conflicts
        document.getElementById('efficiency').textContent = '95%'; // Calculate efficiency
    }
    
    function showLoading() {
        loadingState.classList.remove('hidden');
        timetablesContainer.classList.add('hidden');
        emptyState.classList.add('hidden');
    }
    
    function hideLoading() {
        loadingState.classList.add('hidden');
    }
    
    function showTimetable() {
        timetablesContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');
    }
    
    function showEmptyState() {
        emptyState.classList.remove('hidden');
        timetablesContainer.classList.add('hidden');
    }
    
    function showGenerationModal() {
        generationModal.classList.remove('hidden');
    }
    
    function hideGenerationModal() {
        generationModal.classList.add('hidden');
    }
    
    function showToast(message, type = 'info') {
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');
        
        toastMessage.textContent = message;
        
        // Set icon based on type
        const icons = {
            success: '<svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>',
            error: '<svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>',
            info: '<svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'
        };
        
        toastIcon.innerHTML = icons[type] || icons.info;
        
        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }
    
    // Filter functions
    function populateFilterDropdowns() {
        if (!timetableData || timetableData.length === 0) return;
        
        // Get unique semesters
        const semesters = [...new Set(timetableData.map(entry => entry.semester_name))].sort();
        semesterSelect.innerHTML = '<option value="">All Semesters</option>';
        semesters.forEach(semester => {
            const option = document.createElement('option');
            option.value = semester;
            option.textContent = semester;
            semesterSelect.appendChild(option);
        });
    }
    
    function updateDepartmentOptions() {
        const selectedSemester = semesterSelect.value;
        departmentSelect.innerHTML = '<option value="">All Departments</option>';
        departmentSelect.disabled = !selectedSemester;
        sectionSelect.innerHTML = '<option value="">All Sections</option>';
        sectionSelect.disabled = true;
        
        if (!selectedSemester) return;
        
        // Get departments for selected semester
        const departments = [...new Set(
            timetableData
                .filter(entry => entry.semester_name === selectedSemester)
                .map(entry => entry.department_name)
        )].sort();
        
        departments.forEach(department => {
            const option = document.createElement('option');
            option.value = department;
            option.textContent = department;
            departmentSelect.appendChild(option);
        });
    }
    
    function updateSectionOptions() {
        const selectedSemester = semesterSelect.value;
        const selectedDepartment = departmentSelect.value;
        sectionSelect.innerHTML = '<option value="">All Sections</option>';
        sectionSelect.disabled = !selectedDepartment;
        
        if (!selectedDepartment) return;
        
        // Get sections for selected semester and department
        const sections = [...new Set(
            timetableData
                .filter(entry => 
                    entry.semester_name === selectedSemester && 
                    entry.department_name === selectedDepartment
                )
                .map(entry => entry.section_name)
        )].sort();
        
        sections.forEach(section => {
            const option = document.createElement('option');
            option.value = section;
            option.textContent = section;
            sectionSelect.appendChild(option);
        });
    }
    
    function applyFilter() {
        const selectedSemester = semesterSelect.value;
        const selectedDepartment = departmentSelect.value;
        const selectedSection = sectionSelect.value;
        
        console.log('🔍 Applying filter:', { selectedSemester, selectedDepartment, selectedSection });
        
        // Filter sections based on selections
        let filteredSections = sections;
        
        if (selectedSemester) {
            filteredSections = filteredSections.filter(section => section.semester === selectedSemester);
            console.log('📚 After semester filter:', filteredSections.length, 'sections');
        }
        
        if (selectedDepartment) {
            filteredSections = filteredSections.filter(section => section.department === selectedDepartment);
            console.log('📚 After department filter:', filteredSections.length, 'sections');
        }
        
        if (selectedSection) {
            filteredSections = filteredSections.filter(section => section.section === selectedSection);
            console.log('📚 After section filter:', filteredSections.length, 'sections');
        }
        
        console.log('✅ Final filtered sections:', filteredSections.length);
        
        // Re-render with filtered sections
        renderFilteredTimetable(filteredSections);
    }
    
    function clearFilter() {
        semesterSelect.value = '';
        departmentSelect.value = '';
        sectionSelect.value = '';
        departmentSelect.disabled = true;
        sectionSelect.disabled = true;
        
        // Re-render with all sections
        renderFilteredTimetable(sections);
    }
    
    function renderFilteredTimetable(filteredSections) {
        const days = SETTINGS.working_days || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const periods = generatePeriods();
        
        // Clear container
        timetablesContainer.innerHTML = '';
        
        if (filteredSections.length === 0) {
            timetablesContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No timetables found for the selected criteria.</div>';
            return;
        }
        
        // Create tables for filtered sections
        filteredSections.forEach((sectionGroup, index) => {
            const sectionData = sectionGroup.entries;
            const sectionName = sectionGroup.section;
            const departmentName = sectionGroup.department;
            const semesterName = sectionGroup.semester;
            
            // Create section card
            const sectionCard = document.createElement('div');
            sectionCard.className = 'glass-card p-6';
            
            // Section header
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'mb-4 flex items-center justify-between';
            sectionHeader.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-200">${semesterName} - ${departmentName} - ${sectionName}</h3>
                <span class="text-sm text-gray-400">${sectionData.length} classes scheduled</span>
            `;
            sectionCard.appendChild(sectionHeader);
            
            // Create table (same logic as before)
            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto';
            
            const table = document.createElement('table');
            table.className = 'w-full border-collapse border border-gray-600';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-200 font-medium">Time</th>';
            days.forEach(day => {
                headerRow.innerHTML += `<th class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-200 font-medium">${day}</th>`;
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            periods.forEach(period => {
                const row = document.createElement('tr');
                
                // Style break periods differently
                if (period.isBreak) {
                    row.innerHTML = `<td class="border border-gray-600 px-4 py-2 bg-orange-800 text-orange-200 font-medium">${period.time}</td>`;
                    
                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'border border-gray-600 px-2 py-1 min-h-[40px] bg-orange-900';
                        
                        const breakDiv = document.createElement('div');
                        breakDiv.className = 'text-orange-300 text-center py-2 font-medium text-sm';
                        breakDiv.textContent = 'BREAK';
                        cell.appendChild(breakDiv);
                        
                        row.appendChild(cell);
                    });
                } else {
                    row.innerHTML = `<td class="border border-gray-600 px-4 py-2 bg-gray-800 text-gray-200 font-medium">${period.time}</td>`;
                    
                    days.forEach(day => {
                        const cellData = sectionData.filter(entry => 
                            entry.day === day && entry.period === period.number
                        );
                        
                        const cell = document.createElement('td');
                        cell.className = 'border border-gray-600 px-2 py-1 min-h-[60px] bg-gray-900';
                        
                        if (cellData.length > 0) {
                            const entry = cellData[0];
                            const subjectName = entry.subject_name || entry.course_name || 'Unknown';
                            const teacherName = entry.teacher || 'Unknown';
                            const roomName = entry.classroom || 'Unknown';
                            
                            cell.innerHTML = `
                                <div class="text-sm font-medium text-blue-300">${subjectName}</div>
                                <div class="text-xs text-gray-400">${teacherName}</div>
                                <div class="text-xs text-gray-500">${roomName}</div>
                            `;
                        } else {
                            cell.innerHTML = '<div class="text-gray-600 text-center">-</div>';
                        }
                        
                        row.appendChild(cell);
                    });
                }
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            sectionCard.appendChild(tableContainer);
            timetablesContainer.appendChild(sectionCard);
        });
    }
});
</script>
{% endblock %}
